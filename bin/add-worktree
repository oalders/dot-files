#!/usr/bin/env bash

set -e -u -o pipefail

if [ $# -ne 1 ]; then
    echo "Usage: add-worktree branch-name"
    exit
fi

branch_name="$1"
number=""
type=""

# Pattern matching for GitHub issues and PRs
if [[ $branch_name =~ ^fix-([0-9]+)$ ]]; then
    number="${BASH_REMATCH[1]}"
    type="issue"
elif [[ $branch_name =~ ^gh-([0-9]+)$ ]]; then
    number="${BASH_REMATCH[1]}"
    type="pr"
fi

set -x

git_dir=$(git rev-parse --git-common-dir)

if [[ -z $git_dir ]]; then
    echo "This command must be run from inside a git repository"
    exit
fi

# shellcheck disable=SC2153
if [[ $MY_INSIDE_TMUX == true ]]; then
    echo "Detach from tmux before running this command"
    exit
fi

cd "$git_dir/.." || exit 1

repo_name="$(basename "$(pwd)")"
date_stamp="$(date +%Y-%m-%d)"

all_worktrees="$HOME/.worktree/$repo_name/$date_stamp"
mkdir -p "$all_worktrees"

worktree_dir="$all_worktrees/$branch_name"

if [[ "$type" == "pr" ]]; then
    # For PR checkouts, create worktree without -b flag (gh pr checkout will create the branch)
    git worktree add "$worktree_dir"
else
    git worktree add "$worktree_dir" -b "$branch_name"
fi

cd "$worktree_dir" || exit 1

# Handle GitHub PRs and issues
if [[ "$type" == "pr" ]]; then
    gh pr checkout "$number"
elif [[ "$type" == "issue" ]]; then
    gh issue edit "$number" --add-label "in progress"
fi
if [[ -f package.json ]]; then
    npm i && git co package-lock.json
fi
if [[ -f bin/init.sh ]]; then
    ./bin/init.sh
fi

bash ~/dot-files/bin/claude-mcp

if [[ -n $(pgrep tmux) ]]; then
    . ~/dot-files/bash_functions.sh

    tmux_session_name # exports $SESSION_NAME
    if [[ -n $(pgrep tmux) ]]; then
        tmux new -s "$SESSION_NAME"
    else
        tmux new -s "$SESSION_NAME" -d
    fi
fi
