#!/usr/bin/env bash

set -e -u -o pipefail

if [ $# -ne 1 ]; then
    echo "Usage: add-worktree branch-name"
    exit
fi

branch_name="$1"
pr_number=""

# Check if this is a PR checkout (gh-XXX format)
if [[ "$branch_name" == gh-* ]]; then
    pr_number="${branch_name#gh-}"
fi

set -x

git_dir=$(git rev-parse --git-common-dir)

if [[ -z $git_dir ]]; then
    echo "This command must be run from inside a git repository"
    exit
fi

# shellcheck disable=SC2153
if [[ $MY_INSIDE_TMUX == true ]]; then
    echo "Detach from tmux before running this command"
    exit
fi

cd "$git_dir/.." || exit 1

repo_name="$(basename "$(pwd)")"
date_stamp="$(date +%Y-%m-%d)"

all_worktrees="$HOME/.worktree/$repo_name/$date_stamp"
mkdir -p "$all_worktrees"

worktree_dir="$all_worktrees/$branch_name"

if [[ -n "$pr_number" ]]; then
    # For PR checkouts, create worktree without -b flag (gh pr checkout will create the branch)
    git worktree add "$worktree_dir"
else
    git worktree add "$worktree_dir" -b "$branch_name"
fi

cd "$worktree_dir" || exit 1

# If this is a PR, checkout the PR using gh
if [[ -n "$pr_number" ]]; then
    if [[ "$branch_name" == gh-* ]]; then
        gh pr checkout "$pr_number"
    else
        gh issue edit "$pr_number" --add-label "in progress"
    fi
fi
if [[ -f package.json ]]; then
    npm i
fi

bash ~/dot-files/bin/claude-mcp

if [[ -n $(pgrep tmux) ]]; then
    . ~/dot-files/bash_functions.sh

    tmux_session_name # exports $SESSION_NAME
    tmux new -s "$SESSION_NAME"
fi
